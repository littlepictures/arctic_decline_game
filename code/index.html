<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arctic Decline</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
  </head>

  <body>
    <div id="splash" class="screen">
      <h1>Arctic Decline</h1>
      <p>this game is based on real data: <br>the length of the ice sheets <br>matches the arctic ice mass</p>
      <p>use &#8679; and &#8681; keys to move your ice sheet</p>
      <p> </p>
      <button id="startBtn">Press Start</button>
    </div>

    <div id="endGame1" class="screen" style="display: none;">
      <h1>You made it to 2023</h1>
      <p>congrats: life is only getting harder from here</p>
      <br>
      <button id="endGameBtn">New Game</button>
    </div>

    <div id="endGame2" class="screen" style="display: none;">
      <h1>"New Game?!"</h1>
      <p>why do you expect to have another chance?</p>
      <p>there is no such thing as time travel...</p>
      <div class="share-bar">
          <a href="https://www.facebook.com/sharer/sharer.php?u=YOUR_URL" target="_blank">
            <img src="https://cdn3.iconfinder.com/data/icons/social-media-black-white-2/512/BW_Facebook_glyph_svg-64.png" alt="Share on Facebook" width="32" height="32">
          </a>
          <a href="https://www.instagram.com/sharer.php?u=YOUR_URL" target="_blank">
            <img src="https://cdn1.iconfinder.com/data/icons/social-media-circle-7/512/Circled_Instagram_svg-64.png" alt="Share on Instagram" width="32" height="32">
          </a>
          <a href="https://twitter.com/share?url=YOUR_URL" target="_blank">
            <img src="https://cdn1.iconfinder.com/data/icons/social-media-circle-7/512/Circled_Twitter_svg-64.png" alt="Share on Twitter" width="32" height="32">
          </a>
        </div>
    </div>

    <canvas id="game" width="700" height="500"></canvas>
    <p id="levelText" class="background-text"></p>
    <p id="iceMassData" class="background-text"></p>

    <script>
      let levels = [];
      let iceMassData = [];
      let levelTexts = [];
      let levelYear = [];

      fetch('levels.json')
        .then(response => response.json())
        .then(data => {
          levels = data.levels;
          iceMassData = levels.map(level => level.iceMassData);
          levelTexts = levels.map(level => level.text);
          levelYear = levels.map(level => level.year);
        });

      // Get the canvas element and its context
      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");

      const normalizePaddleLength = (paddleLength, icemassdata) => {
        const minPaddleLength = 15;
        const maxPaddleLength = 110;
        const normalizedLength = minPaddleLength + ((icemassdata - 3) / (8 - 3)) * (maxPaddleLength - minPaddleLength);
        return normalizedLength;
      };

      function updateLevelTexts(level) {
        const currentLevel = levels.find(l => l.level === level.toString());
        if (!currentLevel) return;
        const levelText = currentLevel.text;
        const iceMassData = currentLevel.iceMassData;

        // Update the level and iceMassData text on the page
        document.getElementById('levelText').innerHTML = levelText;
        document.getElementById('iceMassData').innerHTML = iceMassData;
      }

      // Player paddle object
      const player = {
        x: 10,
        y: canvas.height / 2 - 50,
        width: 10,
        height: 110, // Set initial height
        initialHeight: 110, // store the initial height
        color: "#fff",
        level: 1,
        score: 0,
      };

      // AI paddle object
      const ai = {
        x: canvas.width - 20,
        y: canvas.height / 2 - 50,
        width: 10,
        height: 110, // Set initial height
        initialHeight: 110, // store the initial height
        color: "#fff",
        level: 1,
      };

      const text = levelTexts[player.level - 1] || "";
      const maxLevel = 44;

      // event listeners for keydown and keyup events
      document.addEventListener("keydown", keyDownHandler);
      document.addEventListener("keyup", keyUpHandler);

      // Variable to track the paddle's direction
      let playerDirection = 0;

      // Keydown handler function
      function keyDownHandler(e) {
        if (e.key === "ArrowUp") {
          playerDirection = -1;
        } else if (e.key === "ArrowDown") {
          playerDirection = 1;
        }
      }

      // Keyup handler function
      function keyUpHandler(e) {
        if (e.key === "ArrowUp" || e.key === "ArrowDown") {
          playerDirection = 0;
        }
      }

      function handleTouchStart(e) {
        const touchY = e.touches[0].clientY;
        if (touchY < canvas.height / 2) {
          playerDirection = -1;
        } else {
          playerDirection = 1;
        }
      }

      function handleTouchEnd() {
        playerDirection = 0;
      }

      canvas.addEventListener("touchstart", handleTouchStart);
      canvas.addEventListener("touchend", handleTouchEnd);

      // Ball object
      const ball = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        radius: 7,
        color: "#fff",
        speed: 3,
        velocityX: 3,
        velocityY: 3,
      };

      // Draw a rectangle
      function drawRect(x, y,  width, height, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, width, height);
      }

      // Draw a ball
      function drawBall(x, y, radius, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2, false);
        ctx.closePath();
        ctx.fill();
      }

      // Draw score
      function drawScore() {
        ctx.fillStyle = "#fff";
        ctx.font = "10px 'Press Start 2P'";
        ctx.textAlign = "center";
        ctx.fillText("Score: " + player.score, canvas.width / 2, canvas.height - 10);
      }

      // Main game function
      let isGameRunning = false;
      function game() {
        if (!isGameRunning) {
          isGameRunning = true;
        }
        update();
        render();
        requestAnimationFrame(game);
      }

      // Update the game state
      function update() {
        ball.x += ball.velocityX;
        ball.y += ball.velocityY;

        // Check for collisions with canvas borders
        if (ball.y + ball.radius > canvas.height || ball.y - ball.radius < 0) {
          ball.velocityY = -ball.velocityY;
        }

        // Determine the paddle to check for collisions
        let paddle = ball.x < canvas.width / 2 ? player : ai;

        // Check for collisions with the paddle
        if (collision(ball, paddle)) {
          let angle = (Math.random() - 0.5) * Math.PI / 4;
          ball.velocityX = -ball.velocityX;
          ball.velocityY = ball.speed * Math.sin(angle);
        }

        // Check for collisions with left and right borders
        if (ball.x - ball.radius < 0) {
          resetBall();
        } else if (ball.x + ball.radius > canvas.width) {
          resetBall();
        }

        // Update player paddle position based on direction
        player.y += playerDirection * 5;

        // Check for player paddle collisions with canvas borders
        if (player.y < 0) {
          player.y = 0;
        } else if (player.y + player.height > canvas.height) {
          player.y = canvas.height - player.height;
        }

        // AI paddle movement
        ai.y += (ball.y - (ai.y + ai.height / 2)) * 0.1;

        // Check collision with the player paddle
        if (collision(ball, player)) {
          ball.velocityX = Math.abs(ball.velocityX);
          player.score += 10;
        }

        // Check collision with the AI paddle
        if (collision(ball, ai)) {
          ball.velocityX = -Math.abs(ball.velocityX);
        }
      }

      // Check if ball collides with a paddle
      function collision(b, p) {
        const collided =
          b.x + b.radius > p.x &&
          b.x - b.radius < p.x + p.width &&
          b.y + b.radius > p.y &&
          b.y - b.radius < p.y + p.height;

        return collided;
      }

      // Reset ball position and update paddle heights
      function resetBall() {
        ball.x = canvas.width / 2;
        ball.y = canvas.height / 2;
        ball.velocityX = -ball.velocityX;
        ball.velocityY = (Math.random() - 0.5) * 10;
        player.height = normalizePaddleLength(player.initialHeight, iceMassData[player.level - 1]);
        ai.height = normalizePaddleLength(ai.initialHeight, iceMassData[ai.level - 1]);
        player.level++; // increase player's level
        ai.level++; // increase ai's level

        stopLevelInterval(); // Stop the level change interval
        levelInterval = setInterval(increaseLevel, 7000); // Start the level change interval again

        // Check if the player has reached maxLevel
        if (player.level === maxLevel) {
          stopLevelInterval(); // Stop the level change interval
          canvas.style.display = "none"; // Hide the game canvas
          document.getElementById("endGame1").style.display = "flex"; // Show the end game message
        }
        }

      // Render game objects
      function render() {
        drawRect(0, 0, canvas.width, canvas.height, "#000");
        drawRect(player.x, player.y, player.width, player.height, player.color);
        drawRect(ai.x, ai.y, ai.width, ai.height, ai.color);

        // Display level in the center of the field
        const lightBlue = "#8cc3d5";
        const darkRed = "#8b0000";
        const factor = Math.min((player.level - 1) / maxLevel, 1);
        const levelColor = interpolateColor(lightBlue, darkRed, factor);
        ctx.fillStyle = levelColor;
        ctx.font = "bold 30px 'Press Start 2P'";
        ctx.textAlign = "center";
        ctx.fillText(1979 + player.level, canvas.width / 2, canvas.height / 2);

        // Draw level text
        const text = levelTexts[player.level - 1] || "";
        ctx.fillStyle = levelColor;
        ctx.font = "15px 'Press Start 2P'";
        ctx.textAlign = "center";
        ctx.fillText(text, canvas.width / 2, canvas.height / 2 + 40);
        
        // Draw the ball
        drawBall(ball.x, ball.y, ball.radius, ball.color);

        // Draw the ball
        drawScore();
      }

      let levelInterval;

      function stopLevelInterval() {
      clearInterval(levelInterval);
      }

      // Increase player and AI levels
      function increaseLevel() {
        player.level++; // increase player's level
        ai.level++; // increase ai's level
        player.height = normalizePaddleLength(player.initialHeight, iceMassData[player.level - 1]);
        ai.height = normalizePaddleLength(ai.initialHeight, iceMassData[ai.level - 1]);

        // Check if the player has reached level maxLevel
        if (player.level === maxLevel) {
          stopLevelInterval(); // Stop the level change interval
          canvas.style.display = "none"; // Hide the game canvas
          document.getElementById("endGame1").style.display = "flex"; // Show the end game message
        }
      }

      // Start the game when the start button is clicked
      document.getElementById("startBtn").addEventListener("click", () => {
        document.getElementById("splash").style.display = "none";
        canvas.style.display = "block";
        game();
        levelInterval = setInterval(increaseLevel, 7000);
      });

      document.getElementById("endGameBtn").addEventListener("click", () => {
        document.getElementById("endGame1").style.display = "none";
        document.getElementById("splash").style.display = "none";
        document.getElementById("endGame2").style.display = "block";
      });

      // Stop the level change interval
      function stopLevelInterval() {
        clearInterval(levelInterval); // Clear the level change interval
      }

      // Interpolate between two colors based on a factor
      function interpolateColor(color1, color2, factor) {
        const r1 = parseInt(color1.substring(1, 3), 16);
        const g1 = parseInt(color1.substring(3, 5), 16);
        const b1 = parseInt(color1.substring(5, 7), 16);

        const r2 = parseInt(color2.substring(1, 3), 16);
        const g2 = parseInt(color2.substring(3, 5), 16);
        const b2 = parseInt(color2.substring(5, 7), 16);

        const r = Math.round(r1 + factor * (r2 - r1));
        const g = Math.round(g1 + factor * (g2 - g1));
        const b = Math.round(b1 + factor * (b2 - b1));

        return (
          "#" +
          r.toString(16).padStart(2, "0") +
          g.toString(16).padStart(2, "0") +
          b.toString(16).padStart(2, "0")
        );
      }

      // Initialize the game
      game();

</script>
</body>
</html>